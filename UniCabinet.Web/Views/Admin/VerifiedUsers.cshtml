@using UniCabinet.Web.ViewModel
@model StudentGroupViewModel

<h3>Список пользователй</h3>

<form method="get" asp-action="VerifiedUsers" id="roleFilterForm">
    <div class="form-group">
        <label for="roleFilter">Выберите роль для фильтрации:</label>
        <select class="form-control" id="roleFilter" name="role">
           
            @foreach (var role in (IEnumerable<SelectListItem>)ViewBag.Roles)
            {
                <option value="@role.Value" selected>@role.Text</option>
            }
        </select>
    </div>
</form>


@if (Model.Users != null && Model.Users.Any())

{
    <h2>Результаты фильтрации</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Полное Имя</th>
                <th>Роли</th>
                <th>Текущая Группа</th>
                <th>Изменить Группу</th>
                <th>Изменить Роль</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model.Users)

            {
                <tr>
                    <td>@user.Email</td>
                    <td>@user.FullName</td>
                    <td>@string.Join(", ", user.Roles)</td>
                    <td>@user.GroupName</td>
                    <td>
                        @if (user.Roles.Contains("Student") && user.Roles.Contains("Verified"))

                        {
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#groupModal_@user.Id">
                                Изменить группу
                            </button>
                            @Html.Partial("_GroupModal", user)
                        }

                        else

                        {
                            <span class="text-muted">Изменение группы недоступно</span>
                        }
                    </td>
                    <td>
                        <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#roleModal_@user.Id">
                            Изменить роль
                        </button>
                        @Html.Partial("_RoleModal", user)
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

else

{
    <p>Нет пользователей, удовлетворяющих условиям фильтрации.</p>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            var selectedRole = '@ViewBag.SelectedRole';

            if (selectedRole && selectedRole !== '') {
                $('#roleFilter').val(selectedRole);
            } else {
                $('#roleFilter').val('Student');
            }

            $('#roleFilter').change(function () {
                $('#roleFilterForm').submit();
            });
        });
    </script>
}
